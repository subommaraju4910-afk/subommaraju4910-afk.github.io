<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Squat Fix – AI Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.10.14"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.10.14"></script>

  <!-- Alpine.js -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <style>
    :root { --p: #7c81ff; --g:#6acb8a; --r:#ff6565; --y:#ffcb66; --gray:#444; }
    body { background:#f4f4f8; margin:0; font-family:'Segoe UI',sans-serif; color:#333; }
    .container { max-width:1050px; margin:auto; padding:22px; }
    h1 { text-align:center; color:#6060e0; margin-bottom:5px; }
    .subtitle { text-align:center; color:#666; font-size:15px; margin-top:-5px; }

    /** Upload box **/
    .drop {
      padding:50px; border:3px dashed #ccc; border-radius:15px;
      background:white; cursor:pointer; transition:0.3s;
      text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .drop.dragover { background:#f3f1ff; border-color:var(--p); }

    /** Buttons **/
    .btn {
      padding:10px 20px; border-radius:8px; border:none; cursor:pointer;
      font-weight:600; color:white; margin:6px; transition:0.2s;
      box-shadow:0 3px 10px rgba(0,0,0,0.12);
    }
    .p { background:var(--p); } .p:hover { background:#6158df; }
    .g { background:var(--g); } .g:hover { background:#4dbb70; }
    .r { background:var(--r); } .r:hover { background:#ff4a4a; }
    .gray { background:var(--gray); } .gray:hover { background:#222; }
    .btn:disabled { opacity:0.45; cursor:not-allowed; }

    /** Loading **/
    #loaderBar { height:12px; background:#e3e3e3; border-radius:10px; margin:20px 0; overflow:hidden; }
    #loaderFill { height:100%; width:0%; background:var(--p); transition:0.25s; }

    /** Canvas **/
    canvas {
      width:100%; border-radius:12px; background:#000;
      margin-top:25px; box-shadow:0 4px 14px rgba(0,0,0,0.15);
    }

    /** Result panel **/
    .result {
      background:white; padding:20px; border-radius:14px;
      margin-top:22px; box-shadow:0 3px 12px rgba(0,0,0,0.12);
    }
    .issue { padding:12px; margin:8px 0; border-left:5px solid; border-radius:6px; }
    .major { background:#ffe6e6; border-color:var(--r); }
    .minor { background:#fff3d9; border-color:var(--y); }
    .good { background:#e6fbe6; border-color:var(--g); }
  </style>
</head>

<body>
<div class="container" x-data="squatApp()" x-init="init()">

  <h1>Squat Fix</h1>
  <p class="subtitle">AI shows exactly what you're doing wrong – fully fixed version</p>

  <!-- Upload -->
  <div class="drop"
       :class="dragging ? 'dragover' : ''"
       @dragover.prevent="dragging = true"
       @dragleave.prevent="dragging = false"
       @drop.prevent="handleDrop($event)"
       @click="$refs.fileInput.click()">

    <p style="font-size:32px; margin:0;">⬆️ Upload</p>
    <p>Drop photo or video<br><small>or click to browse</small></p>

    <input type="file" x-ref="fileInput" hidden accept="image/*,video/*" @change="handleFile($event)">
  </div>

  <!-- Buttons -->
  <div style="text-align:center; margin-top:14px;">
    <button class="btn p" @click="analyze()" :disabled="!file || loading">Analyze</button>
    <button class="btn g" @click="startCamera()" :disabled="loading || camActive">Live Camera</button>
    <button class="btn r" @click="stopCamera()" :disabled="!camActive">Stop</button>
    <button class="btn gray" @click="resetAll()">Clear</button>
  </div>

  <!-- Loader -->
  <div x-show="loading" id="loaderBar">
    <div id="loaderFill" :style="{ width: progress + '%' }"></div>
  </div>

  <p x-show="loading" style="text-align:center; margin-top:-8px; color:#666;">
    <span x-text="statusText"></span> ( <span x-text="progress"></span>% )
  </p>

  <!-- Canvas -->
  <canvas x-ref="canvas"></canvas>

  <!-- Results -->
  <div class="result" x-show="result">
    <h3 style="margin-top:0;">Squat Analysis</h3>

    <template x-for="item in result.items" :key="item.title">
      <div class="issue" :class="item.type">
        <strong x-text="item.title"></strong><br>
        <span x-text="item.msg"></span>
      </div>
    </template>
  </div>

</div>

<script>
function squatApp() {
  return {
    pose: null,
    canvas: null,
    ctx: null,
    file: null,
    result: null,
    camActive: false,
    loading: false,
    dragging: false,
    progress: 0,
    statusText: "Loading...",
    videoEl: null,
    camera: null,

    /** ---------------- INIT ---------------- */
    async init() {
      this.canvas = this.$refs.canvas;
      this.ctx = this.canvas.getContext("2d");

      const base = "https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.10.14";

      this.pose = new Pose({
        locateFile: f => `${base}/${f}`
      });

      this.pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7,
        selfieMode: false,
        modelAssetPath: `${base}/pose_landmark_full.tflite`
      });

      this.pose.onResults(r => this.processPose(r));
    },

    /** ----------- FILE HANDLING ----------- */
    handleDrop(e) {
      this.dragging = false;
      const f = e.dataTransfer.files[0];
      if (f) this.file = f;
    },
    handleFile(e) {
      const f = e.target.files[0];
      if (f) this.file = f;
    },

    /** ---------------- ANALYZE ---------------- */
    async analyze() {
      if (!this.file) return;

      this.loading = true;
      this.progress = 20;
      this.statusText = "Preparing file...";

      const url = URL.createObjectURL(this.file);

      if (this.file.type.startsWith("image")) {
        await this.processImage(url);
      } else {
        await this.processVideo(url);
      }

      URL.revokeObjectURL(url);
      this.loading = false;
    },

    /** ---- PROCESS IMAGE ---- */
    async processImage(url) {
      const img = new Image();
      img.src = url;

      await img.decode();

      this.progress = 60;
      this.statusText = "Analyzing image...";

      this.setCanvasSize(img);
      const result = await this.sendToPose(img);
      this.processPose(result);
    },

    /** ---- PROCESS VIDEO ---- */
    async processVideo(url) {
      const v = document.createElement("video");
      v.src = url;

      await v.play().catch(() => {});
      await new Promise(res => v.onloadedmetadata = res);

      this.videoEl = v;

      const frames = [0.2, 0.5, 0.8];
      let best = null;
      let bestScore = -999;

      for (let i = 0; i < frames.length; i++) {
        const t = v.duration * frames[i];
        v.currentTime = t;

        await new Promise(res => v.onseeked = res);

        this.statusText = `Analyzing frame ${i + 1}/${frames.length}`;
        this.progress = 30 + (i + 1) * 20;

        const r = await this.sendToPose(v);
        this.processPose(r);

        if (this.result && this.result.score > bestScore) {
          bestScore = this.result.score;
          best = { ...this.result };
        }
      }

      this.result = best;
    },

    /** ---- SEND TO MEDIAPIPE ---- */
    async sendToPose(image) {
      return new Promise(resolve => {
        const handler = (r) => {
          this.pose.off("results", handler);
          resolve(r);
        };
        this.pose.onResults(handler);
        this.pose.send({ image });
      });
    },

    /** ------- CAMERA ------- */
    async startCamera() {
      this.resetAll();
      this.camActive = true;

      const video = document.createElement("video");
      this.videoEl = video;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.play();

        this.camera = new Camera(video, {
          onFrame: async () => {
            await this.pose.send({ image: video });
          },
          width: 640,
          height: 480
        });

        this.camera.start();
      } catch (err) {
        this.camActive = false;
        alert("Camera permission denied.");
      }
    },

    stopCamera() {
      if (this.camera) this.camera.stop();
      this.camActive = false;
    },

    /** ---------- PROCESS RESULTS ---------- */
    processPose(r) {
      if (!r || !r.poseLandmarks) return;

      const img = r.image;
      this.setCanvasSize(img);
      this.ctx.drawImage(img, 0, 0);

      const lm = r.poseLandmarks.map(p => ({ ...p }));
      this.drawSkeleton(lm);
      this.result = this.evaluateSquat(lm);
    },

    /** ---------- DRAW SKELETON ---------- */
    drawSkeleton(lm) {
      const c = this.canvas;
      const ctx = this.ctx;

      const lines = [
        [11,13],[13,15],
        [12,14],[14,16],
        [23,25],[25,27],
        [24,26],[26,28]
      ];

      ctx.lineWidth = 5;
      ctx.strokeStyle = "#00e5ff";

      for (const [a, b] of lines) {
        if (lm[a].visibility < .6 || lm[b].visibility < .6) continue;
        ctx.beginPath();
        ctx.moveTo(lm[a].x * c.width, lm[a].y * c.height);
        ctx.lineTo(lm[b].x * c.width, lm[b].y * c.height);
        ctx.stroke();
      }
    },

    /** ----------- SCORING LOGIC ----------- */
    evaluateSquat(lm) {

      const L = i => lm[i];

      const hipY = (L(23).y + L(24).y) / 2;
      const ankleY = (L(27).y + L(28).y) / 2;
      const shoulder = { x: (L(11).x + L(12).x)/2, y:(L(11).y + L(12).y)/2 };

      const legLength = Math.abs(hipY - ankleY);
      let depthPct = ((ankleY - hipY) / legLength) * 100;
      depthPct = Math.max(0, Math.min(120, Math.round(depthPct)));

      const torso = {
        x: shoulder.x - ((L(23).x + L(24).x)/2),
        y: shoulder.y - hipY
      };
      const backAngle = Math.round(
        Math.acos(Math.abs(torso.y) / Math.hypot(torso.x, torso.y)) * 180 / Math.PI
      );

      const drift = Math.round(
        ((Math.abs(L(25).x - L(27).x)) + Math.abs(L(26).x - L(28).x)) * 30
      );

      let score = 100;
      const issues = [];

      if (depthPct < 40) { score -= 35; issues.push({ type:"major", title:"Squat too high", msg:"Drop hips lower." }); }
      else if (depthPct < 70) { score -= 10; issues.push({ type:"minor", title:"Shallow squat", msg:"Go deeper for full ROM." }); }

      if (backAngle > 35) { score -= 25; issues.push({ type:"major", title:"Back leaning forward", msg:"Keep chest upright." }); }
      else if (backAngle > 20) { score -= 10; issues.push({ type:"minor", title:"Chest falling slightly", msg:"Engage core more." }); }

      if (drift > 20) { score -= 20; issues.push({ type:"major", title:"Knees too far forward", msg:`Excessive knee drift (${drift}cm).` }); }

      if (issues.length === 0)
        issues.push({ type:"good", title:"Excellent squat!", msg:"Form looks great." });

      return { score, items: issues };
    },

    /** ---------- UTIL ---------- */
    setCanvasSize(img) {
      this.canvas.width = img.width || img.videoWidth;
      this.canvas.height = img.height || img.videoHeight;
    },

    resetAll() {
      this.stopCamera();
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      this.result = null;
      this.file = null;
      this.loading = false;
      this.progress = 0;
    }
  };
}
</script>

</body>
</html>
