<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Squat Form Analyzer</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MediaPipe Pose + Camera utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.10.14"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.10.14"></script>

  <style>
    #outputCanvas { max-width:100%; border-radius:.5rem; }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <header class="bg-indigo-600 text-white p-4 shadow-md">
    <h1 class="text-2xl font-bold text-center">Live Squat Form Analyzer</h1>
    <p class="text-center opacity-90 text-sm">Real‑time feedback – webcam only</p>
  </header>

  <main class="flex-1 container mx-auto p-6 max-w-5xl" x-data="app()">
    <!-- ==== Controls ==== -->
    <div class="flex flex-wrap gap-3 justify-center mb-6">
      <button @click="startWebcam()"
              :disabled="webcamActive"
              class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
        Start Webcam
      </button>

      <button @click="stopWebcam()"
              :disabled="!webcamActive"
              class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50">
        Stop Webcam
      </button>

      <button @click="clearAll()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
        Clear
      </button>
    </div>

    <!-- ==== Video + Canvas ==== -->
    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div>
        <video id="webcamVideo" class="max-w-full rounded-lg shadow hidden" autoplay playsinline></video>
      </div>
      <div>
        <canvas id="outputCanvas" class="hidden w-full bg-black"></canvas>
        <p x-show="!hasPose && webcamActive" class="text-center text-gray-500 mt-4">Looking for pose…</p>
      </div>
    </div>

    <!-- ==== Live Analysis ==== -->
    <div x-show="webcamActive && result" class="bg-white p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4">Live Squat Analysis</h2>

      <div class="grid grid-cols-3 gap-4 mb-4 text-center">
        <div class="p-3 bg-green-100 rounded">
          <p class="text-2xl font-bold text-green-800" x-text="result.score + '/100'"></p>
          <p class="text-xs">Score</p>
        </div>
        <div class="p-3 bg-blue-100 rounded">
          <p class="font-bold text-blue-800" x-text="result.exercise"></p>
          <p class="text-xs">Exercise</p>
        </div>
        <div class="p-3 bg-purple-100 rounded">
          <p class="font-bold text-purple-800" x-text="result.depth + '%'"></p>
          <p class="text-xs">Depth</p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
        <div class="p-2 bg-yellow-100 rounded">
          <p class="font-medium">Back Angle</p>
          <p x-text="result.backAngle + '°'"></p>
        </div>
        <div class="p-2 bg-orange-100 rounded">
          <p class="font-medium">Knee Drift</p>
          <p x-text="result.kneeDrift + ' cm'"></p>
        </div>
      </div>

      <div class="prose prose-sm" x-html="result.feedback"></div>
    </div>
  </main>

  <!-- ==================== Alpine + Logic ==================== -->
  <script>
    function app() {
      return {
        webcamActive: false,
        hasPose: false,
        result: null,
        pose: null,
        camera: null,
        canvas: null,
        ctx: null,
        video: null,

        // -------------------------------------------------
        async startWebcam() {
          this.clearAll();
          this.webcamActive = true;

          this.video = document.getElementById('webcamVideo');
          this.video.classList.remove('hidden');

          this.canvas = document.getElementById('outputCanvas');
          this.canvas.classList.remove('hidden');
          this.ctx = this.canvas.getContext('2d');

          // init MediaPipe
          this.pose = new Pose({
            locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.10.14/${f}`
          });
          this.pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
          });
          this.pose.onResults(r => this.onPoseResults(r));

          this.camera = new Camera(this.video, {
            onFrame: async () => {
              await this.pose.send({image: this.video});
            },
            width: 640,
            height: 480
          });
          this.camera.start();
        },

        stopWebcam() {
          if (this.camera) this.camera.stop();
          this.webcamActive = false;
          this.hasPose = false;
          this.result = null;
        },

        clearAll() {
          this.stopWebcam();
          if (this.video) this.video.srcObject = null;
          if (this.canvas) this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        },

        // -------------------------------------------------
        onPoseResults(results) {
          if (!this.canvas || !this.ctx) return;

          // resize canvas to video size
          if (this.video.videoWidth) {
            this.canvas.width = this.video.videoWidth;
            this.canvas.height = this.video.videoHeight;
          }

          this.ctx.save();
          this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
          this.ctx.drawImage(results.image, 0,0,this.canvas.width,this.canvas.height);

          if (results.poseLandmarks) {
            this.hasPose = true;
            this.drawSkeleton(results.poseLandmarks);
            this.analyzeSquatLive(results.poseLandmarks);
          } else {
            this.hasPose = false;
          }
          this.ctx.restore();
        },

        drawSkeleton(landmarks) {
          const connections = [
            [11,13],[13,15],[12,14],[14,16], // arms
            [11,12],[23,24],                 // hips
            [23,25],[25,27],[24,26],[26,28]  // legs
          ].map(([a,b]) => [landmarks[a], landmarks[b]]);

          this.ctx.strokeStyle = '#10b981';
          this.ctx.lineWidth = 4;
          connections.forEach(([a,b]) => {
            if (a.visibility > .5 && b.visibility > .5) {
              this.ctx.beginPath();
              this.ctx.moveTo(a.x*this.canvas.width, a.y*this.canvas.height);
              this.ctx.lineTo(b.x*this.canvas.width, b.y*this.canvas.height);
              this.ctx.stroke();
            }
          });

          this.ctx.fillStyle = '#10b981';
          landmarks.forEach(lm => {
            if (lm.visibility > .5) {
              this.ctx.beginPath();
              this.ctx.arc(lm.x*this.canvas.width, lm.y*this.canvas.height, 6, 0, 2*Math.PI);
              this.ctx.fill();
            }
          });
        },

        // -------------------------------------------------
        analyzeSquatLive(landmarks) {
          const lm = i => ({x:landmarks[i].x, y:landmarks[i].y, v:landmarks[i].visibility});

          const leftHip = lm(23), rightHip = lm(24);
          const leftKnee = lm(25), rightKnee = lm(26);
          const leftAnkle = lm(27), rightAnkle = lm(28);
          const leftShoulder = lm(11), rightShoulder = lm(12);

          // visibility check
          if ([leftHip,rightHip,leftKnee,rightKnee,leftAnkle,rightAnkle,
               leftShoulder,rightShoulder].some(p=>p.v<.5)) {
            this.result = {exercise:"Squat (partial)", score:0, depth:0, backAngle:0, kneeDrift:0,
                           feedback:"<p class='text-red-700'>Not all landmarks visible – face the camera.</p>"};
            return;
          }

          // Helper math
          const vec = (a,b) => ({x:b.x-a.x, y:b.y-a.y});
          const dot = (a,b) => a.x*b.x + a.y*b.y;
          const norm = v => Math.sqrt(v.x*v.x + v.y*v.y);
          const angleDeg = (a,b) => Math.acos(Math.max(-1,Math.min(1, dot(a,b)/(norm(a)*norm(b)+1e-6)))) * 180/Math.PI;

          // --- Depth (hip height) ---
          const hipY = (leftHip.y + rightHip.y) / 2;
          const depthPct = Math.round((1 - hipY) * 100); // 0% = standing, 100% = full squat

          // --- Back angle (torso vs vertical) ---
          const torsoVec = vec(leftHip, leftShoulder);
          const backAngle = Math.round(angleDeg(torsoVec, {x:0,y:-1}));

          // --- Knee drift (horizontal distance knee‑ankle) ---
          const leftDrift = Math.abs(leftKnee.x - leftAnkle.x);
          const rightDrift = Math.abs(rightKnee.x - rightAnkle.x);
          const kneeDriftCm = Math.round(((leftDrift + rightDrift)/2) * 100); // rough pixel‑to‑cm

          // --- Symmetry (hip height diff) ---
          const hipDiff = Math.abs(leftHip.y - rightHip.y);
          const symmetryOk = hipDiff < 0.03;

          // --- Scoring ---
          let score = 100;
          const issues = [];

          // Depth
          if (depthPct < 40) { issues.push(`Shallow squat (${depthPct}% depth). Aim for ≥70%.`); score -= 30; }
          else if (depthPct < 70) { issues.push(`Good depth (${depthPct}%), push a bit lower.`); score -= 10; }

          // Back
          if (backAngle > 30) { issues.push(`Back leaning ${backAngle}° – stay upright.`); score -= (backAngle-20)*1.5; }
          else if (backAngle > 15) { issues.push(`Slight lean (${backAngle}°). Keep torso vertical.`); score -= 5; }

          // Knee drift
          if (kneeDriftCm > 8) { issues.push(`Knees drift ${kneeDriftCm} cm forward – track over toes.`); score -= 20; }

          // Symmetry
          if (!symmetryOk) { issues.push(`Uneven hips – keep weight balanced.`); score -= 15; }

          score = Math.max(0, Math.min(100, Math.round(score)));

          // Feedback HTML
          const feedback = issues.length
            ? `<ul class="list-disc pl-5 space-y-1 text-red-700">${issues.map(i=>`<li>${i}</li>`).join('')}</ul>`
            : `<p class="text-green-700 font-semibold">Perfect form! Keep it up.</p>`;

          this.result = {
            exercise: "Squat",
            score,
            depth: depthPct,
            backAngle,
            kneeDrift: kneeDriftCm,
            feedback
          };
        }
      };
    }
  </script>

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>
