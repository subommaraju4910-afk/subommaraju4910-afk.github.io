<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SquatSense AI - Full Analysis</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f7fc;
    color: #333;
    text-align: center;
    padding: 2rem;
  }
  #upload-area {
    border: 2px dashed #aaa;
    padding: 3rem;
    margin-bottom: 1rem;
    cursor: pointer;
    border-radius: 12px;
    background: white;
  }
  #upload-area:hover {
    border-color: #5566cc;
  }
  #progress-bar {
    width: 80%;
    height: 12px;
    background: #ddd;
    margin: 1rem auto;
    border-radius: 6px;
    overflow: hidden;
  }
  #progress-bar-fill {
    height: 100%;
    background: #6677ff;
    width: 0%;
    transition: width 0.3s ease;
  }
  button {
    padding: 0.5rem 1.2rem;
    margin: 0.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  button#analyze-btn {
    background: #6677ff;
    color: white;
  }
  button#clear-btn {
    background: #444;
    color: white;
  }
  #report {
    margin-top: 2rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    background: #fff;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 0 8px #ccc;
    text-align: left;
  }
  canvas {
    margin-top: 1rem;
    border-radius: 12px;
    max-width: 100%;
  }
  .issue {
    padding:10px;
    margin:6px 0;
    border-left:4px solid;
    border-radius:6px;
  }
  .major { background:#ffe6e6; border-color:#ff7b7b; }
  .minor { background:#fff4e6; border-color:#ffb84d; }
  .good { background:#e6f7e6; border-color:#6acb8a; }
</style>
</head>
<body>

<h1>SquatSense AI</h1>
<p>Upload an image or video of your squat and get a full form analysis report.</p>

<div id="upload-area" tabindex="0">
  ⬆️ Drop photo or video here or click to browse
  <input type="file" id="file-input" accept="image/*,video/*" style="display:none" />
</div>

<div>
  <button id="analyze-btn" disabled>Analyze</button>
  <button id="clear-btn" disabled>Clear</button>
</div>

<div id="progress-bar">
  <div id="progress-bar-fill"></div>
</div>

<canvas id="canvas"></canvas>
<div id="report"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.10.14"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.10.14"></script>

<script>
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');
const analyzeBtn = document.getElementById('analyze-btn');
const clearBtn = document.getElementById('clear-btn');
const progressBarFill = document.getElementById('progress-bar-fill');
const reportDiv = document.getElementById('report');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let selectedFile = null;
let pose;

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('keydown', e => { if(e.key==='Enter'||e.key===' ') fileInput.click(); });

fileInput.addEventListener('change', e => {
  if(e.target.files.length){
    selectedFile = e.target.files[0];
    reportDiv.innerHTML = `<p>Selected file: <strong>${selectedFile.name}</strong></p>`;
    analyzeBtn.disabled = false;
    clearBtn.disabled = false;
    progressBarFill.style.width='0%';
  }
});

clearBtn.addEventListener('click', () => {
  selectedFile=null;
  fileInput.value='';
  reportDiv.innerHTML='';
  analyzeBtn.disabled=true;
  clearBtn.disabled=true;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  progressBarFill.style.width='0%';
});

analyzeBtn.addEventListener('click', async () => {
  if(!selectedFile) return;
  analyzeBtn.disabled=true;
  clearBtn.disabled=true;
  reportDiv.innerHTML=`<p>Analyzing ${selectedFile.name}...</p>`;
  await analyzeFile(selectedFile);
  analyzeBtn.disabled=false;
  clearBtn.disabled=false;
});

async function analyzeFile(file){
  progressBarFill.style.width='10%';
  if(!pose){
    pose = new Pose({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.10.14/${f}`});
    pose.setOptions({
      modelComplexity:1,
      smoothLandmarks:true,
      minDetectionConfidence:0.5,
      minTrackingConfidence:0.5
    });
  }

  return new Promise((resolve)=>{
    pose.onResults(results => {
      progressBarFill.style.width='100%';
      drawResults(results);
      const report = analyzePose(results.poseLandmarks);
      showReport(report, file.name);
      resolve();
    });

    const url = URL.createObjectURL(file);
    if(file.type.startsWith('image')){
      const img = new Image();
      img.onload = ()=>{ canvas.width=img.width; canvas.height=img.height; pose.send({image:img}); };
      img.src=url;
    } else {
      const video = document.createElement('video');
      video.src = url;
      video.onloadedmetadata = async ()=>{
        video.currentTime = video.duration/2;
        video.onseeked = async ()=>{
          canvas.width=video.videoWidth;
          canvas.height=video.videoHeight;
          await pose.send({image:video});
        };
      };
      video.play();
    }
  });
}

function drawResults(landmarks){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!landmarks) return;
  ctx.strokeStyle='#00ffff'; ctx.lineWidth=4;
  const pairs=[[11,13],[13,15],[12,14],[14,16],[11,12],[23,24],[23,25],[25,27],[24,26],[26,28]];
  pairs.forEach(([a,b])=>{
    const p1=landmarks[a], p2=landmarks[b];
    if(p1.visibility>0.6 && p2.visibility>0.6){
      ctx.beginPath();
      ctx.moveTo(p1.x*canvas.width,p1.y*canvas.height);
      ctx.lineTo(p2.x*canvas.width,p2.y*canvas.height);
      ctx.stroke();
    }
  });
}

function analyzePose(lm){
  if(!lm || lm.length===0) return {items:[{type:'major',title:'No Person',msg:'No person detected.'}],score:0};

  const L=i=>lm[i];
  const hip={x:(L(23).x+L(24).x)/2, y:(L(23).y+L(24).y)/2};
  const ankleY=(L(27).y+L(28).y)/2;
  const kneeL=L(25), kneeR=L(26);
  const shoulder={x:(L(11).x+L(12).x)/2, y:(L(11).y+L(12).y)/2};

  const legLen=((L(23).y-L(27).y)+(L(24).y-L(28).y))/2;
  const depth=Math.round(((ankleY-hip.y)/legLen)*100);

  const torso={x:shoulder.x-hip.x, y:shoulder.y-hip.y};
  const backAngle=Math.round(Math.acos(Math.abs(torso.y)/Math.hypot(torso.x,torso.y))*180/Math.PI);

  const drift=Math.round(Math.abs((kneeL.x-L(27).x)+(kneeR.x-L(28).x))/2*60);

  const issues=[]; let score=100;
  if(depth<40){score-=35; issues.push({type:'major',title:'Too High',msg:'Hips above knees!'});}
  else if(depth<70){score-=10; issues.push({type:'minor',title:'Shallow',msg:'Go a bit deeper.'});}
  if(backAngle>35){score-=25; issues.push({type:'major',title:'Back Leaning',msg:'Keep chest up!'});}
  else if(backAngle>20){score-=10; issues.push({type:'minor',title:'Slight Lean',msg:'Stay upright.'});}
  if(drift>10){score-=20; issues.push({type:'major',title:'Knees Forward',msg:`${drift}cm past toes!`});}
  if(issues.length===0) issues.push({type:'good',title:'Perfect!',msg:'Great squat form!'});
  return {items:issues, score:Math.max(0,Math.round(score))};
}

function showReport(report, filename){
  let html=`<h2>Analysis Report for ${filename}</h2>`;
  report.items.forEach(i=>{
    html+=`<div class="issue ${i.type}"><strong>${i.title}</strong>: ${i.msg}</div>`;
  });
  reportDiv.innerHTML=html;
}
</script>

</body>
</html>
