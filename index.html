async startAnalyze() {
  if (!this.file) return;
  this.loading = true;
  this.prog = 0;
  this.msg = 'Preparing...';
  this.result = null;

  const url = URL.createObjectURL(this.file);

  if (this.file.type.startsWith('image')) {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = async () => {
      this.canv.width = img.naturalWidth;
      this.canv.height = img.naturalHeight;
      this.ctx.drawImage(img, 0, 0);
      this.prog = 20;
      this.msg = 'Analyzing image...';
      await this.pose.send({ image: img });
      this.done(url);
    };
    img.onerror = () => {
      this.error('Image failed to load', url);
    };
    img.src = url;
  } else if (this.file.type.startsWith('video')) {
    const vid = document.createElement('video');
    vid.src = url;
    vid.crossOrigin = 'anonymous';
    vid.muted = true;
    vid.playsInline = true;

    vid.onloadedmetadata = async () => {
      const frames = [0.25, 0.5, 0.75];  // analyze at 25%, 50%, 75%
      let bestScore = -Infinity;
      let bestResult = null;

      for (let i = 0; i < frames.length; i++) {
        vid.currentTime = vid.duration * frames[i];
        await new Promise(resolve => {
          vid.onseeked = resolve;
        });

        this.prog = 30 + ((i + 1) * 20);  // progress increments 50%, 70%, 90%
        this.msg = `Analyzing frame ${i + 1} / ${frames.length}...`;

        await this.pose.send({ image: vid });

        if (this.result && this.result.score > bestScore) {
          bestScore = this.result.score;
          bestResult = JSON.parse(JSON.stringify(this.result));
        }
      }

      this.result = bestResult || {
        items: [{ type: 'minor', title: 'No squat detected', msg: 'Could not analyze form.' }],
        score: 0,
      };
      this.done(url);
    };

    vid.onerror = () => {
      this.error('Video failed to load', url);
    };
  } else {
    this.error('Unsupported file type', url);
  }
},

analyzePose(landmarks) {
  const L = i => landmarks[i];
  const hip = { x: (L(23).x + L(24).x) / 2, y: (L(23).y + L(24).y) / 2 };
  const ankle = { y: (L(27).y + L(28).y) / 2 };
  const kneeL = L(25), kneeR = L(26);
  const shoulder = { x: (L(11).x + L(12).x) / 2, y: (L(11).y + L(12).y) / 2 };

  // Calculate squat depth (% relative to leg length)
  const legLen = ((L(23).y - L(27).y) + (L(24).y - L(28).y)) / 2;
  const depth = Math.round(((ankle.y - hip.y) / legLen) * 100);

  // Calculate back angle from hip to shoulder
  const torso = { x: shoulder.x - hip.x, y: shoulder.y - hip.y };
  const backAngle = Math.round(
    Math.acos(Math.abs(torso.y) / Math.hypot(torso.x, torso.y)) * (180 / Math.PI)
  );

  // Knee drift past toes (horizontal)
  const drift = Math.round(
    (Math.abs(kneeL.x - L(27).x) + Math.abs(kneeR.x - L(28).x)) / 2 * 60
  );

  // Knee valgus check (distance between knees)
  const kneeSpread = Math.abs(kneeL.x - kneeR.x);
  const kneeSpreadNorm = kneeSpread * 60;

  // Hip rotation check (simple proxy: difference in knee y values)
  const hipRotation = Math.abs(kneeL.y - kneeR.y) * 60;

  const issues = [];
  let score = 100;

  // Depth feedback
  if (depth < 40) {
    score -= 35;
    issues.push({ type: 'major', title: 'Too High', msg: 'Drop hips below knees!' });
  } else if (depth < 70) {
    score -= 10;
    issues.push({ type: 'minor', title: 'Shallow', msg: 'Go 2â€“3" deeper.' });
  }

  // Back posture feedback
  if (backAngle > 35) {
    score -= 25;
    issues.push({ type: 'major', title: 'Back Leaning', msg: 'Keep chest up!' });
  } else if (backAngle > 20) {
    score -= 10;
    issues.push({ type: 'minor', title: 'Slight Lean', msg: 'Try to stay more upright.' });
  }

  // Knee drift forward
  if (drift > 10) {
    score -= 20;
    issues.push({ type: 'major', title: 'Knees Forward', msg: `${drift}cm past toes!` });
  }

  // Knee valgus (knees collapsing inward)
  if (kneeSpreadNorm < 10) {
    score -= 15;
    issues.push({ type: 'major', title: 'Knees Inward', msg: 'Knees collapsing!' });
  }

  // Hip rotation imbalance
  if (hipRotation > 5) {
    score -= 15;
    issues.push({ type: 'minor', title: 'Hip Rotation', msg: 'Uneven hips detected.' });
  }

  if (issues.length === 0) {
    issues.push({ type: 'good', title: 'Perfect!', msg: 'Excellent squat form!' });
  }

  return { items: issues, score: Math.max(0, Math.round(score)) };
},

done(url) {
  this.loading = false;
  this.prog = 100;
  this.msg = 'Analysis complete!';
  URL.revokeObjectURL(url);
},
